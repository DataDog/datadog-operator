package fake

import (
	"testing"

	commonv1 "github.com/DataDog/datadog-operator/apis/datadoghq/common/v1"
	merger "github.com/DataDog/datadog-operator/controllers/datadogagent/merger"

	v1 "k8s.io/api/core/v1"
)

// VolumeManager is an autogenerated mock type for the VolumeManager type
type VolumeManager struct {
	Volumes        []*v1.Volume
	VolumeMountByC map[commonv1.AgentContainerName][]*v1.VolumeMount

	t testing.TB
}

// AddVolume provides a mock function with given fields: volume, volumeMount
func (_m *VolumeManager) AddVolume(volume *v1.Volume, volumeMount *v1.VolumeMount) {
	_m.Volumes = append(_m.Volumes, volume)
	_m.VolumeMountByC[AllContainers] = append(_m.VolumeMountByC[AllContainers], volumeMount)
}

// AddVolumeToContainer provides a mock function with given fields: volume, volumeMount, containerName
func (_m *VolumeManager) AddVolumeToContainer(volume *v1.Volume, volumeMount *v1.VolumeMount, containerName commonv1.AgentContainerName) {
	_m.Volumes = append(_m.Volumes, volume)
	_m.VolumeMountByC[containerName] = append(_m.VolumeMountByC[containerName], volumeMount)
}

// AddVolumeToContainers provides a mock function with given fields: volume, volumeMount, containerNames
func (_m *VolumeManager) AddVolumeToContainers(volume *v1.Volume, volumeMount *v1.VolumeMount, containerNames []commonv1.AgentContainerName) {
	_m.Volumes = append(_m.Volumes, volume)
	for _, c := range containerNames {
		_m.VolumeMountByC[c] = append(_m.VolumeMountByC[c], volumeMount)
	}
}

// AddVolumeToContainersWithMergeFunc provides a mock function with given fields: volume, volumeMount, containerNames, volumeMergeFunc, volumeMountMergeFunc
func (_m *VolumeManager) AddVolumeToContainersWithMergeFunc(volume *v1.Volume, volumeMount *v1.VolumeMount, containerNames []commonv1.AgentContainerName, volumeMergeFunc merger.VolumeMergeFunction, volumeMountMergeFunc merger.VolumeMountMergeFunction) error {
	if err := _m.volumeMerge(volume, volumeMergeFunc); err != nil {
		return err
	}
	for _, cName := range containerNames {
		if err := _m.volumeMountMerge(cName, volumeMount, volumeMountMergeFunc); err != nil {
			return err
		}
	}
	return nil
}

func (_m *VolumeManager) volumeMerge(volume *v1.Volume, volumeMergeFunc merger.VolumeMergeFunction) error {
	found := false
	idFound := 0
	for id, v := range _m.Volumes {
		if volume.Name == v.Name {
			found = true
			idFound = id
		}
	}

	if found {
		var err error
		volume, err = volumeMergeFunc(_m.Volumes[idFound], volume)
		_m.Volumes[idFound] = volume
		return err
	}

	_m.Volumes = append(_m.Volumes, volume)
	return nil
}

func (_m *VolumeManager) volumeMountMerge(containerName commonv1.AgentContainerName, volume *v1.VolumeMount, volumeMergeFunc merger.VolumeMountMergeFunction) error {
	found := false
	idFound := 0
	for id, v := range _m.VolumeMountByC[containerName] {
		if volume.Name == v.Name {
			found = true
			idFound = id
		}
	}

	if found {
		var err error
		volume, err = volumeMergeFunc(_m.VolumeMountByC[containerName][idFound], volume)
		_m.VolumeMountByC[containerName][idFound] = volume
		return err
	}

	_m.VolumeMountByC[containerName] = append(_m.VolumeMountByC[containerName], volume)
	return nil
}

// AddVolumeWithMergeFunc provides a mock function with given fields: volume, volumeMount, volumeMergeFunc, volumeMountMergeFunc
func (_m *VolumeManager) AddVolumeWithMergeFunc(volume *v1.Volume, volumeMount *v1.VolumeMount, volumeMergeFunc merger.VolumeMergeFunction, volumeMountMergeFunc merger.VolumeMountMergeFunction) error {
	return _m.AddVolumeToContainersWithMergeFunc(volume, volumeMount, []commonv1.AgentContainerName{AllContainers}, volumeMergeFunc, volumeMountMergeFunc)
}

// NewFakeVolumeManager creates a new instance of VolumeManager. It also registers the testing.TB interface on the mock and a cleanup function to assert the mocks expectations.
func NewFakeVolumeManager(t testing.TB) *VolumeManager {
	return &VolumeManager{
		VolumeMountByC: make(map[commonv1.AgentContainerName][]*v1.VolumeMount),
		t:              t,
	}
}
