name: pull request linter
on:
  pull_request_target:
    types: [opened, labeled, unlabeled, synchronize]
  pull_request:
    types: [opened, labeled, unlabeled, synchronize, milestoned, demilestoned]

permissions: {}

jobs:
  build:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Verify Pull Request Labels
      uses: jesusvasquez333/verify-pr-label-action@657d111bbbe13e22bbd55870f1813c699bde1401 # v1.4.0
      with:
        github-token: '${{ secrets.GITHUB_TOKEN }}'
        valid-labels: 'bug, enhancement, refactoring, documentation, tooling, dependencies'
        pull-request-number: '${{ github.event.pull_request.number }}'
        disable-reviews: true
  check-milestone:
    name: Check Milestone
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Check milestone and labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }})
          MILESTONE=$(echo "$PR_JSON" | jq -r '.milestone.title // empty')
          HAS_SKIP_QA=$(echo "$PR_JSON" | jq -r '[.labels[].name] | any(. == "qa/skip-qa")')
          if [ -z "$MILESTONE" ] && [ "$HAS_SKIP_QA" != "true" ]; then
            echo "::error::Missing milestone or \`qa/skip-qa\` label"
            exit 1
          fi
