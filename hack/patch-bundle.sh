#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

SCRIPTS_DIR="$(dirname "$0")"
# Provides $OS,$ARCH,$PLAFORM,$ROOT variables
source "$SCRIPTS_DIR/os-env.sh"

YQ="$ROOT/bin/$PLATFORM/yq"

# Apply patch-bundle-csv-scc.yaml on CSV file
# (cannot be done using Kustomize as the final CSV is generated by operator-sdk binary)
$YQ -i ".spec.install.spec.clusterPermissions += load(\"$ROOT/hack/patch-bundle-csv-scc.yaml\")" $ROOT/bundle/manifests/datadog-operator.clusterserviceversion.yaml

# Add annotation required for upstream publication
IMAGE=$($YQ '.spec.install.spec.deployments[0].spec.template.spec.containers[0].image' bundle/manifests/datadog-operator.clusterserviceversion.yaml)
$YQ -i ".metadata.annotations.containerImage = \"$IMAGE\"" bundle/manifests/datadog-operator.clusterserviceversion.yaml

# Add skipRange annotation to allow direct upgrades
VERSION=$($YQ '.spec.version' bundle/manifests/datadog-operator.clusterserviceversion.yaml )
$YQ -i ".metadata.annotations.\"olm.skipRange\" = \"<$VERSION\"" bundle/manifests/datadog-operator.clusterserviceversion.yaml

# Delete replaces
$YQ -i 'del(.spec.replaces)' bundle/manifests/datadog-operator.clusterserviceversion.yaml

# Add OpenShift version annotation (adding in main bundle as it's used for OpenShift Community)
$YQ -i ".annotations.\"com.redhat.openshift.versions\" = \"v4.6\"" bundle/metadata/annotations.yaml
